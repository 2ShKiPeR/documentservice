Document Service

Сервис управления документами с поддержкой статусов, batch-операций и конкурентного утверждения.

Поиск документов

Endpoint:

GET /documents/search


Поддерживаемые фильтры:

status

author

from — начало периода

to — конец периода

Период трактуется по дате создания документа (createdAt).

Дополнительно поддерживаются:

page

size

sortBy

direction

Пример запроса:

GET /documents/search?status=APPROVED&author=Ivan&page=0&size=10

Как запустить сервис
1. Создать базу данных PostgreSQL
CREATE DATABASE documentdb;

2. Указать параметры подключения в application.yml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/documentdb
    username: your_user
    password: your_password

3. Запустить приложение




Liquibase автоматически создаст таблицы и индексы.

Как проверить работу сервиса
1. Создать документ

POST /documents

2. Выполнить submit

POST /documents/submit

3. Проверить approve

POST /documents/{id}/concurrent-approve

4. Проверить поиск

GET /documents/search

Как проверить прогресс по логам

В логах отображается:

запуск приложения

выполнение SubmitWorker (каждые 10 секунд)

выполнение ApproveWorker (каждые 15 секунд)

успешные и неуспешные операции

Пример логов:

Submitted document 5
Approved document 5


Это позволяет отслеживать прогресс batch-обработки.

Что бы я изменил для обработки 5000+ id в одном запросе

Если требуется обрабатывать 5000+ id в одном batch-запросе:

Разбивать входной список на чанки (например, по 500–1000 id).

Использовать bulk-update вместо обработки каждого id по отдельности.

Минимизировать количество обращений к БД (один SELECT по списку id вместо N запросов).

Использовать асинхронную обработку (через очередь или executor).

При необходимости — вынести batch-обработку в отдельный сервис.

Это снизит нагрузку на БД и уменьшит время ответа.

Как вынести реестр утверждений в отдельную систему

Возможны два варианта:

1. Отдельная база данных

approval_registry хранится в другой БД

используется отдельный datasource

транзакционность обеспечивается через механизм событий (event-driven подход)

2. Отдельный HTTP-сервис

после успешного approve публикуется событие

отдельный сервис принимает запрос и сохраняет запись в свой storage

взаимодействие может быть:

синхронным (REST)

асинхронным (Kafka / RabbitMQ)

Предпочтительный вариант — асинхронная интеграция через брокер сообщений, чтобы избежать распределённых транзакций.

Примечание

Для защиты от конкурентных изменений используется optimistic locking (@Version).

Для ускорения выборок добавлены индексы, включая композитный индекс (status, created_at).
